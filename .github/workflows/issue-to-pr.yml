name: Issue to PR (add internship)

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    # ðŸ”¥ CHANGE: trigger based on title, not label
    if: startsWith(github.event.issue.title, 'Add internship:')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;

            function getField(label) {
              const re = new RegExp(
                `###\\s+${label}\\s+\\n([^#\\n][\\s\\S]*?)(\\n###|$)`,
                "m"
              );
              const match = body.match(re);
              return match ? match[1].trim().split("\n")[0].trim() : "";
            }

            const company = getField("Company");
            const role = getField("Role title");
            const location = getField("Location");
            const link = getField("Application link");
            const rawDate = process.env.DATE.trim();

            function formatDate(input) {
            const d = new Date(input + "T00:00:00Z");
            if (isNaN(d)) return input;
            return d.toLocaleString("en-US", {
                month: "short",
                day: "numeric"
            });
            }

            const date = formatDate(rawDate);


            if (!company || !role || !location || !link || !date) {
              core.setFailed("Missing required fields in issue form.");
              return;
            }

            core.setOutput("company", company);
            core.setOutput("role", role);
            core.setOutput("location", location);
            core.setOutput("link", link);
            core.setOutput("date", date);

      - name: Update README table
        run: |
          node <<'NODE'
          const fs = require('fs');

          const company = process.env.COMPANY.trim();
          const role = process.env.ROLE.trim();
          let location = process.env.LOCATION.trim();
          const link = process.env.LINK.trim();
          const date = process.env.DATE.trim();

          // Remove the word "Canada" from location (case-insensitive)
          location = location.replace(/\bCanada\b/gi, '').replace(/\s{2,}/g,' ').trim();
          location = location.replace(/,\s*,/g, ',').replace(/,\s*$/g,'').replace(/^\s*,\s*/g,'');

          const begin = "<!-- BEGIN:INTERNSHIPS_TABLE -->";
          const end = "<!-- END:INTERNSHIPS_TABLE -->";

          const readmePath = "README.md";
          let content = fs.readFileSync(readmePath, "utf8");

          const start = content.indexOf(begin);
          const finish = content.indexOf(end);
          if (start === -1 || finish === -1 || finish < start) {
            throw new Error("README markers not found.");
          }

          const before = content.slice(0, start + begin.length);
          const after = content.slice(finish);

          const sectionRaw = content.slice(start + begin.length, finish);
          const lines = sectionRaw.split('\n');

          // Find the last table row (line that starts with | and has at least 5 columns)
          // We'll insert BEFORE the first blank line after the table, or at the end of section.
          let insertAt = lines.length;

          // If there is an empty line after the last row, insert before it.
          for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i].trim();
            if (line === "") continue;
            // First non-empty from bottom: insert right after it
            insertAt = i + 1;
            break;
          }

          const applyBadge = `[![Apply](https://img.shields.io/badge/-Apply-blue?style=for-the-badge)](${link})`;

          const newRow = `| ${company} | ${role} | ${location} | ${applyBadge} | ${date} |`;

          // Prevent exact duplicate row
          const existing = sectionRaw.split('\n').some(l => l.trim() === newRow.trim());
          if (!existing) {
            lines.splice(insertAt, 0, newRow);
          }

          const newSection = "\n" + lines.join("\n").trimEnd() + "\n";
          const updated = before + newSection + after;

          fs.writeFileSync(readmePath, updated, "utf8");
          NODE
        env:
          COMPANY: ${{ steps.parse.outputs.company }}
          ROLE: ${{ steps.parse.outputs.role }}
          LOCATION: ${{ steps.parse.outputs.location }}
          LINK: ${{ steps.parse.outputs.link }}
          DATE: ${{ steps.parse.outputs.date }}

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/add-listing-${{ github.event.issue.number }}
          title: ${{ github.event.issue.title }}
          commit-message: "chore(listings): add internship"
          body: |
            Closes #${{ github.event.issue.number }}
            Added via issue form automation.
          labels: automation
          delete-branch: true

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: "âœ… A pull request has been opened automatically for this listing."
            });
