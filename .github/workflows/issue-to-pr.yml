name: Issue to PR (add internship)

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-pr:
    if: startsWith(github.event.issue.title, 'Add internship:')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Parse issue form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            function getField(label) {
              const re = new RegExp(`###\\s+${label}\\s+\\n([^#\\n][\\s\\S]*?)(\\n###|$)`, "m");
              const m = body.match(re);
              return m ? m[1].trim().split("\n")[0].trim() : "";
            }

            const company = getField("Company");
            const role = getField("Role title");
            const location = getField("Location");
            const link = getField("Application link");
            const date = getField("Date posted \\(YYYY-MM-DD\\)");

            if (!company || !role || !location || !link || !date) {
              core.setFailed("Missing required fields from issue form.");
              return;
            }

            // Basic sanity check for date format
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
              core.setFailed("Date must be in YYYY-MM-DD format.");
              return;
            }

            core.setOutput("company", company);
            core.setOutput("role", role);
            core.setOutput("location", location);
            core.setOutput("link", link);
            core.setOutput("date", date);

      - name: Update README table
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const company = process.env.COMPANY.trim();
          const role = process.env.ROLE.trim();
          let location = process.env.LOCATION.trim();
          const link = process.env.LINK.trim();
          const rawDate = process.env.DATE.trim();

          // Remove the word "Canada" from location (case-insensitive)
          location = location.replace(/\bCanada\b/gi, '').replace(/\s{2,}/g,' ').trim();
          location = location.replace(/,\s*,/g, ',').replace(/,\s*$/g,'').replace(/^\s*,\s*/g,'');

          // Convert YYYY-MM-DD -> "Dec 30"
          function formatDate(input) {
            const d = new Date(input + "T00:00:00Z");
            if (isNaN(d)) return input;
            return d.toLocaleString("en-US", { month: "short", day: "numeric" });
          }
          const date = formatDate(rawDate);

          const begin = "<!-- BEGIN:INTERNSHIPS_TABLE -->";
          const end = "<!-- END:INTERNSHIPS_TABLE -->";

          const readmePath = "README.md";
          let md = fs.readFileSync(readmePath, "utf8");

          const start = md.indexOf(begin);
          const finish = md.indexOf(end);
          if (start === -1 || finish === -1 || finish < start) {
            throw new Error("README markers not found. Add BEGIN/END markers.");
          }

          const before = md.slice(0, start + begin.length);
          const after = md.slice(finish);

          const sectionRaw = md.slice(start + begin.length, finish);

          // If the section is empty, we won't create a new header.
          // Your README already has the header, so we just insert a row.
          const lines = sectionRaw.split('\n');

          // Use your Apply badge format
          const applyBadge = `[![Apply](https://img.shields.io/badge/-Apply-blue?style=for-the-badge)](${link})`;
          const newRow = `| ${company} | ${role} | ${location} | ${applyBadge} | ${date} |`;

          // Prevent duplicates (exact match)
          const alreadyExists = lines.some(l => l.trim() === newRow.trim());
          if (alreadyExists) {
            console.log("Row already exists. No changes made.");
            process.exit(0);
          }

          // Insert the row right before the END marker (at the end of table section)
          // Keep the existing formatting, just add a new line near the bottom.
          // Find last non-empty line index in section to insert after it.
          let insertAt = lines.length;
          for (let i = lines.length - 1; i >= 0; i--) {
            if (lines[i].trim() !== "") {
              insertAt = i + 1;
              break;
            }
          }
          lines.splice(insertAt, 0, newRow);

          const newSection = "\n" + lines.join("\n").trimEnd() + "\n";
          md = `${before}${newSection}${after}`;

          fs.writeFileSync(readmePath, md, "utf8");
          console.log("README updated with new row.");
          NODE
        env:
          COMPANY: ${{ steps.parse.outputs.company }}
          ROLE: ${{ steps.parse.outputs.role }}
          LOCATION: ${{ steps.parse.outputs.location }}
          LINK: ${{ steps.parse.outputs.link }}
          DATE: ${{ steps.parse.outputs.date }}

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/add-internship-${{ github.event.issue.number }}
          title: ${{ github.event.issue.title }}
          commit-message: "chore(listings): add internship listing"
          body: |
            Closes #${{ github.event.issue.number }}
            Added via issue form automation.
          labels: automation
          delete-branch: true

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: "âœ… Opened a PR automatically for this listing. Please review and merge."
            });
